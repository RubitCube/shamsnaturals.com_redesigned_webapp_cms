# ============================================
# Backend API .htaccess for Test Server
# Location: backend/public/ directory
# Domain: rubitcubedev.com/api/v1 or api.rubitcubedev.com
# ============================================

<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # === Force HTTPS ===
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP:X-Forwarded-SSL} !on
    RewriteRule ^(.*)$ "https://%{HTTP_HOST}%{REQUEST_URI}" [R=301,L]

    # === Handle Authorization Header ===
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # === Redirect Trailing Slashes If Not A Folder ===
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # === Send Requests To Front Controller (Laravel) ===
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>

# === Security: Block sensitive files ===
<FilesMatch "(^\.env|composer\.json|composer\.lock|package\.json|yarn\.lock|artisan|server-status|phpinfo\.php|readme\.md|README\.txt|\.git|\.gitignore|\.gitattributes)$">
    Require all denied
</FilesMatch>

# === Block known malicious patterns ===
RewriteCond %{QUERY_STRING} (\.env|wp-config|eval\(|base64_encode|/etc/passwd|/proc/self/environ) [NC]
RewriteRule .* - [F,L]

# === Disable directory browsing ===
Options -Indexes

# === Security Headers ===
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    # CORS Headers (adjust as needed for test server)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# === Cache static assets ===
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# === Enable compression ===
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# === PHP Handler ===
<IfModule mime_module>
    AddHandler application/x-httpd-ea-php82___lsphp .php .php8 .phtml
</IfModule>

# BEGIN cPanel-generated php ini directives, do not edit
<IfModule php8_module>
    php_flag display_errors Off
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value max_input_vars 1000
    php_value memory_limit 512M
    php_value post_max_size 516M
    php_value session.gc_maxlifetime 1440
    php_value session.save_path "/var/cpanel/php/sessions/ea-php82"
    php_value upload_max_filesize 512M
    php_flag zlib.output_compression On
</IfModule>

<IfModule lsapi_module>
    php_flag display_errors Off
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value max_input_vars 1000
    php_value memory_limit 512M
    php_value post_max_size 516M
    php_value session.gc_maxlifetime 1440
    php_value session.save_path "/var/cpanel/php/sessions/ea-php82"
    php_value upload_max_filesize 512M
    php_flag zlib.output_compression On
</IfModule>
# END cPanel-generated php ini directives, do not edit

# php -- BEGIN cPanel-generated handler, do not edit
<IfModule mime_module>
    AddHandler application/x-httpd-ea-php82___lsphp .php .php8 .phtml
</IfModule>
# php -- END cPanel-generated handler, do not edit

